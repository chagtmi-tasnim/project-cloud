apiVersion: v1
kind: List
items:
  # Database Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: product-database
      namespace: product-management
      labels:
        app: product-database
    spec:
      ports:
        - name: postgresql
          port: 5432
          targetPort: 5432
      selector:
        app: product-database

  # Database DeploymentConfig
  - apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      name: product-database
      namespace: product-management
    spec:
      replicas: 1
      selector:
        app: product-database
      template:
        metadata:
          labels:
            app: product-database
        spec:
          containers:
            - name: postgres
              image: postgres:15-alpine
              ports:
                - containerPort: 5432
              env:
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: db-credentials
                      key: username
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: db-credentials
                      key: password
                - name: POSTGRES_DB
                  value: productdb
              volumeMounts:
                - name: postgres-data
                  mountPath: /var/lib/postgresql/data
                - name: init-script
                  mountPath: /docker-entrypoint-initdb.d
              livenessProbe:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U postgres
                initialDelaySeconds: 10
                periodSeconds: 10
              readinessProbe:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - pg_isready -U postgres
                initialDelaySeconds: 5
                periodSeconds: 5
              resources:
                requests:
                  memory: 256Mi
                  cpu: 100m
                limits:
                  memory: 512Mi
                  cpu: 500m
          volumes:
            - name: postgres-data
              persistentVolumeClaim:
                claimName: product-db-pvc
            - name: init-script
              configMap:
                name: database-init-script
      triggers:
        - type: ConfigChange

  # Database PersistentVolumeClaim
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: product-db-pvc
      namespace: product-management
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi

  # Database Init Script ConfigMap
  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: database-init-script
      namespace: product-management
    data:
      init.sql: |
        CREATE TABLE IF NOT EXISTS products (
          id SERIAL PRIMARY KEY,
          name VARCHAR(255) NOT NULL,
          description TEXT,
          price DECIMAL(10, 2) NOT NULL,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        INSERT INTO products (name, description, price) VALUES
          ('Laptop', 'High-performance laptop with 16GB RAM and 512GB SSD', 999.99),
          ('Wireless Mouse', 'Ergonomic wireless mouse with 2.4GHz connectivity', 29.99),
          ('USB-C Hub', '7-in-1 USB-C hub with multiple ports and fast charging', 49.99),
          ('Mechanical Keyboard', 'RGB mechanical keyboard with hot-swap switches', 129.99),
          ('Monitor Stand', 'Adjustable monitor stand with storage drawer', 39.99),
          ('Desk Lamp', 'LED desk lamp with adjustable brightness and color temperature', 59.99),
          ('External SSD', '1TB portable external SSD with fast read/write speeds', 89.99),
          ('Webcam', '4K webcam with built-in microphone and auto-focus', 79.99);
        
        CREATE INDEX IF NOT EXISTS idx_products_name ON products(name);

  # Database Credentials Secret
  - apiVersion: v1
    kind: Secret
    metadata:
      name: db-credentials
      namespace: product-management
    type: Opaque
    stringData:
      username: postgres
      password: postgres

  # Backend Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: product-backend
      namespace: product-management
      labels:
        app: product-backend
    spec:
      ports:
        - name: api
          port: 5000
          targetPort: 5000
      selector:
        app: product-backend

  # Backend DeploymentConfig
  - apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      name: product-backend
      namespace: product-management
    spec:
      replicas: 2
      selector:
        app: product-backend
      template:
        metadata:
          labels:
            app: product-backend
        spec:
          containers:
            - name: backend
              image: product-backend:latest
              imagePullPolicy: Always
              ports:
                - containerPort: 5000
              env:
                - name: PORT
                  value: "5000"
                - name: DB_HOST
                  value: product-database
                - name: DB_PORT
                  value: "5432"
                - name: DB_NAME
                  value: productdb
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: db-credentials
                      key: username
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: db-credentials
                      key: password
                - name: NODE_ENV
                  value: production
              livenessProbe:
                httpGet:
                  path: /health
                  port: 5000
                initialDelaySeconds: 15
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /health
                  port: 5000
                initialDelaySeconds: 5
                periodSeconds: 5
              resources:
                requests:
                  memory: 256Mi
                  cpu: 100m
                limits:
                  memory: 512Mi
                  cpu: 500m
      triggers:
        - type: ConfigChange

  # Frontend Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: product-frontend
      namespace: product-management
      labels:
        app: product-frontend
    spec:
      ports:
        - name: http
          port: 80
          targetPort: 80
      selector:
        app: product-frontend

  # Frontend DeploymentConfig
  - apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      name: product-frontend
      namespace: product-management
    spec:
      replicas: 2
      selector:
        app: product-frontend
      template:
        metadata:
          labels:
            app: product-frontend
        spec:
          containers:
            - name: frontend
              image: product-frontend:latest
              imagePullPolicy: Always
              ports:
                - containerPort: 80
              env:
                - name: REACT_APP_API_URL
                  value: http://product-backend:5000
              livenessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 15
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 5
                periodSeconds: 5
              resources:
                requests:
                  memory: 128Mi
                  cpu: 50m
                limits:
                  memory: 256Mi
                  cpu: 250m
      triggers:
        - type: ConfigChange

  # Frontend Route (Ingress)
  - apiVersion: route.openshift.io/v1
    kind: Route
    metadata:
      name: product-frontend
      namespace: product-management
    spec:
      host: product-management.example.com
      to:
        kind: Service
        name: product-frontend
      port:
        targetPort: http
      tls:
        termination: edge
        insecureEdgeTerminationPolicy: Redirect

  # Backend Route (API)
  - apiVersion: route.openshift.io/v1
    kind: Route
    metadata:
      name: product-backend
      namespace: product-management
    spec:
      host: api-product-management.example.com
      to:
        kind: Service
        name: product-backend
      port:
        targetPort: api
